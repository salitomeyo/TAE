---
title: "Prediciendo el número de hijos"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sobre los integrantes de la vivienda

## Caracteristicas y composicion del hogar

Lectura de las bases de datos

```{r}
Caracteristicas_hogar_personas <- read.table("Caracteristicas y composicion del hogar.csv", sep = ";", header = T)
```


Nota: la variable P6051 solo será utilizada para la creación de la variable número de hijos, esta no deberia ir como covariable para el ajuste de modelos:

```{r}
aux_creacion_respuesta<-Caracteristicas_hogar_personas[,c("ï..DIRECTORIO","SECUENCIA_P","P6051")]
```



```{r}
head(aux_creacion_respuesta)
```

###Hijos

Filtramos a los hijos si tienen una relacion de hijo/hija o nieto/nieta con el jefe y contamos al numero de hijos por hogar, los hogares se describen con el codigo unico de ï..DIRECTORIO, SECUENCIA_P

```{r}
require(dplyr)

num_hijos <- aux_creacion_respuesta %>%
  filter(P6051 == 3 | P6051 == 4) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P) %>%
  count(SECUENCIA_P)

num_hijos
```

Número de hogares con hijos:
```{r}
dim(num_hijos)[1]
```


```{r}
require(dplyr)

num_integrantes <- Caracteristicas_hogar_personas %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P) %>%
  count(SECUENCIA_P)
num_integrantes
```

Número de hogares

```{r}
dim(num_integrantes)[1]
```







# Número de hijos final 


```{r}
num_hijos_final <- merge(num_integrantes, num_hijos, by =c("ï..DIRECTORIO","SECUENCIA_P"), all.x=TRUE)

num_hijos_final$n.y[is.na(num_hijos_final$n.y)] <- 0
colnames(num_hijos_final) <- c("ï..DIRECTORIO","SECUENCIA_P", "Num Integrantes", "Num Hijos")
```


```{r}
head(num_hijos_final, 10)
```


###Jefes de hogar

Se guarda el codigo unico que identifica a los jefes de cada hogar, se pudo apreciar que los jefes siempre poseen un 1 en el orden, (este valor es invariable por lo que sabemos que si se habla de un individuo de orden 1 se trata de un jefe de hogar), el codigo unico de los jefes es tomado como ï..DIRECTORIO, SECUENCIA_P, ORDEN

```{r}
require(dplyr)

jefes <- aux_creacion_respuesta %>%
  filter(P6051 == 1) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P) %>%
  count(SECUENCIA_P)
```

```{r}
jefes
```



```{r}
rm(aux_creacion_respuesta)
```


# Importación de las bases de datos con sus respectivas variables:

##Caracteristicas_hogar_personas

```{r}
Caracteristicas_hogar_personas <- read.table("Caracteristicas y composicion del hogar.csv", sep = ";", header = T)
```

```{r}
Caracteristicas_hogar_personas<-Caracteristicas_hogar_personas[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P6020", "P6040","P6051", "P5502", "P6071", "P756","P767","P6081", "P6087","P6083","P6088","P6080")]
```


Vamos a filtar la base de datos por el jefe del hogar de tal manera que quede una fila por hogar:

```{r}
Caracteristicas_hogar_personas <- Caracteristicas_hogar_personas[Caracteristicas_hogar_personas$P6051==1,]

head(Caracteristicas_hogar_personas)
```





## Condiciones de vida del hogar y tenencia de bienes (programas)

```{r}
condiciones_de_vida <- read.table("Condiciones de vida del hogar y tenencia de bienes (programas).csv", sep=";", header = T)

condiciones_de_vida <- condiciones_de_vida[, c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P784S4A3")]

head(condiciones_de_vida)
```


Organizamos la variable condiciones de vida para que los hogares aparezcan una sola vez (Un mismo hogar puede recibir varios subsidios):

```{r}
library(dplyr)
data<-group_by(data,id)%>%summarise(n=n[1])
data
```


```{r, message=FALSE, warning=FALSE}
condiciones_de_vida <-   
  group_by(condiciones_de_vida, ï..DIRECTORIO, SECUENCIA_P) %>%
  summarise(P784S4A3=sum(P784S4A3))


```



## Merge de la base de datos de caracteristicas del hogar con condiciones de vida


```{r}
Base1 <- merge(Caracteristicas_hogar_personas, condiciones_de_vida, by = c("ï..DIRECTORIO","SECUENCIA_P"), all.x =TRUE)
tail(Base1)
```


Reemplazar los NA's por ceros dado que se refieren a los hogares que no tienen subsidios:

```{r}
Base1$P784S4A3[is.na(Base1$P784S4A3)] <- 0
tail(Base1)
```

```{r}
rm(Caracteristicas_hogar_personas, condiciones_de_vida)
```


## Datos de la vivienda

```{r}
Datos_vivienda <- read.table("Datos de la vivienda.csv", sep = ";", header = T)

Datos_vivienda<-Datos_vivienda[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","CANT_HOGARES_VIVIENDA","P1070","P4015","P8520","P8520S1","P8520S1A1","P8520S5","P8520S3")]

head(Datos_vivienda)
```


```{r}
Datos_vivienda$CANT_HOGARES_VIVIENDA <- ifelse(Datos_vivienda$CANT_HOGARES_VIVIENDA>1, 1, 0)
```



Merge de Base1 con datos vivienda


```{r}
Base2 <- merge(Datos_vivienda, Base1, by="ï..DIRECTORIO", all.x=T)
```



## Educacion

```{r}
Educacion<- read.table("Educacion.csv", sep = ";", header = T)

Educacion<-Educacion[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P8587","P8586")]

head(Educacion)
```

La variable educación esta por integrantes del hogar, debemos dejar solo los hogares por lo tanto nuevamente a esta variable se le hace un filtro:


```{r}
Educacion <- Educacion %>%
  filter(ORDEN == 1) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P)
```



## Fuerza de trabajo 


```{r}
fuerza_trabajo <- read.table("Fuerza de trabajo.csv", sep=";", header = T)
fuerza_trabajo <- fuerza_trabajo[, c("ï..DIRECTORIO","SECUENCIA_P","ORDEN", "P6435")]

head(fuerza_trabajo)

```


```{r}
fuerza_trabajo <- fuerza_trabajo %>%
  filter(ORDEN == 1) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P)
```

## Salud

```{r}
Salud<- read.table("Salud.csv", sep = ";", header = T)

Salud<-Salud[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P6090","P6127", "P1708","P1708S1")]

head(Salud)
```


```{r}
Salud <- Salud %>%
  filter(ORDEN == 1) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P)
```


## Servicios del hogar

```{r}
ServiciosDelHogar<- read.table("Servicios del hogar.csv", sep = ";", header = T)

ServiciosDelHogar<-ServiciosDelHogar[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P5000","P5666","P5024","P5305", "I_HOGAR")]

head(ServiciosDelHogar)
```



## Tecnologia e información y comunicación

```{r}
tecn_inf_comunicacion <- read.table("Tecnologías de información y comunicación.csv", sep=";", header = T) 

tecn_inf_comunicacion <- tecn_inf_comunicacion[, c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P769")]


head(tecn_inf_comunicacion)
```


```{r}
tecn_inf_comunicacion <- tecn_inf_comunicacion %>%
  filter(ORDEN == 1) %>%
  group_by(ï..DIRECTORIO, SECUENCIA_P)
```


## Tenencia y financiación de la vivienda que ocupa el hogar


```{r}
financiacion_vivienda <- read.table("Tenencia y financiación de la vivienda que ocupa el hogar.csv", sep=";", header = T)


financiacion_vivienda <- financiacion_vivienda[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P5095", "P5130")]

head(financiacion_vivienda)

```


## Uso de energéticos del hogar


```{r}
energeticos_hogar <- read.table("Uso de energéticos del hogar.csv", sep=";", header = T)

energeticos_hogar <- energeticos_hogar[,c("ï..DIRECTORIO","SECUENCIA_P","ORDEN","P5529", "P5018", "P5018S1")]

head(energeticos_hogar)
```


```{r}
energeticos_hogar$P5018S <- energeticos_hogar$P5018/energeticos_hogar$P5018S1
```




# Merge de todas las bases de datos


```{r}
Base_final <- Reduce(function(...) merge (..., by="ï..DIRECTORIO", all.x=T), list(Base2, Educacion, fuerza_trabajo, Salud, ServiciosDelHogar, tecn_inf_comunicacion, financiacion_vivienda, energeticos_hogar, num_hijos_final))
```

